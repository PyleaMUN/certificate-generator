<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyleaMUN 2026 Certificate Generator</title>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            color: #333;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background: #fff;
            padding: 20px 30px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h2, h3 {
            text-align: center;
            color: #002d5a;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 10px;
        }
        fieldset {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        fieldset:disabled {
            opacity: 0.5;
        }
        legend {
            font-weight: bold;
            color: #002d5a;
            padding: 0 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .button {
            display: inline-block;
            width: 100%;
            padding: 12px;
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
        }
        #image-upload-status {
            text-align: center;
            padding: 10px;
            font-style: italic;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        /* Styles for the new delegate list */
        #delegate-list-container { display: none; margin-top: 15px; }
        #delegate-list { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;}
        #delegate-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        #delegate-list li:last-child { border-bottom: none; }
        #delegate-list button { width: 100px; padding: 5px 10px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <h2>PyleaMUN 2026 Certificate Generator</h2>

        <fieldset>
            <legend>Step 1: Load Certificate Template</legend>
            <div class="form-group">
                <label for="image-input">Choose Certificate Image File:</label>
                <input type="file" id="image-input" accept="image/png,image/jpeg" onchange="handleImageUpload()">
            </div>
            <div id="image-upload-status">Please select the certificate background image.</div>
        </fieldset>

        <fieldset id="generator-controls" disabled>
            <legend>Step 2: Generate Certificates</legend>
            
            <h3>Option A: Generate a Single Certificate</h3>
            <div class="form-group">
                <label for="delegate-name">Delegate Name:</label>
                <input type="text" id="delegate-name" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="committee">Committee:</label>
                <input type="text" id="committee" placeholder="Enter committee name">
            </div>
            <button onclick="generateSingleCertificate()" class="button">Generate & Print Single Certificate</button>

            <hr style="margin: 30px 0;">

            <h3>Option B: Generate All from Spreadsheet</h3>
            <div class="form-group">
                <label for="csv-file-input">Upload CSV File:</label>
                <input type="file" id="csv-file-input" accept=".csv" onchange="handleCsvUpload()">
            </div>
            <div id="delegate-list-container">
                <p id="summary-text"></p>
                <ul id="delegate-list"></ul>
            </div>
        </fieldset>
    </div>

    <script>
        let certificateImageData = '';

        function handleImageUpload() {
            const file = document.getElementById('image-input').files[0];
            const statusDiv = document.getElementById('image-upload-status');
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function() {
                certificateImageData = reader.result;
                statusDiv.textContent = `âœ… Template "${file.name}" loaded successfully.`;
                statusDiv.style.color = 'green';
                document.getElementById('generator-controls').disabled = false;
            };
        }

        function generateSingleCertificate() {
            const delegateName = document.getElementById('delegate-name').value;
            const committee = document.getElementById('committee').value;
            if (!delegateName || !committee) {
                alert('Please fill in both fields.');
                return;
            }
            openPrintPreview([{ name: delegateName, committee: committee }]);
        }
        
        function handleCsvUpload() {
            const file = document.getElementById('csv-file-input').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const parsedDelegates = parseCSV(event.target.result);
                if (parsedDelegates.length > 0) {
                    displayDelegateList(parsedDelegates);
                } else {
                    alert('Could not find valid data in the CSV file.');
                }
            };
            reader.readAsText(file);
        }

        function displayDelegateList(delegates) {
            const listContainer = document.getElementById('delegate-list-container');
            const summaryText = document.getElementById('summary-text');
            const ul = document.getElementById('delegate-list');

            summaryText.textContent = `Found ${delegates.length} delegates. Generate each certificate individually:`;
            ul.innerHTML = ''; // Clear previous list

            delegates.forEach(delegate => {
                const li = document.createElement('li');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = delegate.name;
                
                const button = document.createElement('button');
                button.textContent = 'Generate';
                button.className = 'button';
                // Important: We create a function that calls openPrintPreview for THIS specific delegate
                button.onclick = function() {
                    openPrintPreview([delegate]);
                };
                
                li.appendChild(nameSpan);
                li.appendChild(button);
                ul.appendChild(li);
            });

            listContainer.style.display = 'block';
        }

        function parseCSV(csvText) {
            const delegates = [];
            const lines = csvText.trim().split(/\r\n|\n/);
            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 2) {
                    const committee = parts[0].trim().replace(/^"|"$/g, '');
                    const delegateName = parts[1].trim().replace(/^"|"$/g, '');
                    if (delegateName && committee) delegates.push({ name: delegateName, committee: committee });
                }
            }
            return delegates;
        }

        function openPrintPreview(delegateList) {
            if (!certificateImageData) {
                alert("Please select the certificate template image first (Step 1).");
                return;
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert("Please allow pop-ups for this site.");
                return;
            }

            let certificatesHTML = '';
            for (const delegate of delegateList) {
                certificatesHTML += `
                    <div class="certificate-wrapper">
                        <img src="${certificateImageData}" alt="">
                        <div class="overlay-text delegate-name">${delegate.name}</div>
                        <div class="overlay-text committee-name">${delegate.committee}</div>
                    </div>
                `;
            }

            const printDocumentHTML = `
                <!DOCTYPE html><html><head><title>Print Certificate</title><style>
                    @media print { @page { size: A4 landscape; margin: 0; } }
                    body { margin: 0; }
                    .certificate-wrapper { width: 297mm; height: 210mm; position: relative; overflow: hidden; }
                    .certificate-wrapper img { width: 100%; height: 100%; }
                    .overlay-text { 
                        position: absolute;
                        width: 100%;
                        text-align: center; 
                        font-weight: bold; 
                        color: #002d5a; 
                        font-family: 'Times New Roman', Times, serif;
                        left: 50%;
                        transform: translateX(-50%);
                    }
                    /* --- FINAL POSITIONING --- */
                    .delegate-name { 
                        top: 40%; /* Moved down slightly */
                        font-size: 28pt;
                    }
                    .committee-name { 
                        top: 53%; /* UNTOUCHED - This is the perfect position */
                        font-size: 18pt; 
                    }
                </style></head><body>${certificatesHTML}</body></html>
            `;
            
            printWindow.document.write(printDocumentHTML);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
</body>
</html>